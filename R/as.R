# as.tb roxy [sinew] ---- 
#' @title Try to coerce an object into a texblock object
#' @description coerce objects into a tb class object
#' @param x object
#' @return an object of class tb
#' @export
# as.tb function [sinew] ----
as.tb <- function(x){
  UseMethod('as.tb')
}

# as.tb.default roxy [sinew] ---- 
#' @export
# as.tb.default function [sinew] ----
as.tb.default <- function(x){
  class(x) <- 'tb'
  return(x)
}

# as.tb.tb roxy [sinew] ---- 
#' @export
# as.tb.tb function [sinew] ----
as.tb.tb <- function(x){
  return(x)
}

# as.tb.matrix roxy [sinew] ---- 
#' @export
# as.tb.matrix function [sinew] ----
as.tb.matrix <- function(x,...){
  as.tb(as.data.frame(x))
}

# as.tb.dgCMatrix roxy [sinew] ---- 
#' @export
# as.tb.dgCMatrix function [sinew] ----
as.tb.dgCMatrix <- function(x,...){
  x <- as.matrix(x)
  x[which(x==0,arr.ind = TRUE)] <- ' '
  as.tb(x)
}

# as.tb.list roxy [sinew] ---- 
#' @export
# as.tb.list function [sinew] ----
as.tb.list <- function(x,...){
  lapply(x,as.tb)
}

# as.tb.data.frame roxy [sinew] ---- 
#' @import dplyr
#' @importFrom tidyr gather
#' @importFrom rlang !! sym
#' @export
# as.tb.data.frame function [sinew] ----
as.tb.data.frame <- function(x){

  mr <- attr(x,'MULTIROW')
  mc <- attr(x,'MULTICOL')
  ah <- attr(x,'HLINE')
  ac <- attr(x,'CLINE')
  
  suppressWarnings(
  ret <- x%>%
    dplyr::mutate(r=1:n())%>%
    dplyr::mutate_if(is.character, dplyr::coalesce, ... = '')%>%
    tidyr::gather(key='c',value='val',-!!rlang::sym('r'))%>%
    dplyr::mutate_at(dplyr::vars(!!rlang::sym('r'),c),dplyr::funs(as.numeric))%>%
    dplyr::arrange(!!rlang::sym('r'),c)%>%
    dplyr::group_by(!!rlang::sym('r'))%>%
    dplyr::summarise(val=paste0(!!rlang::sym('val'),collapse = '&'))%>%
    dplyr::ungroup()
  )
  
  # multirows
  
  if(!is.null(mr)){
    if(nrow(mr)>0){
      for(i in 1:nrow(mr)){
        nr <- as.numeric(mr$row[i])
        ret$val[nr] <- gsub(mr$new_val[i],
                                 mr$old_val[i],
                                 ret$val[nr],
                                 fixed = TRUE)    
      }
    }
  }
  
  
  # multicols

  if(!is.null(mc)){
    if(nrow(mc)>0){
      for(i in 1:nrow(mc)){
        nr <- as.numeric(mc$row[i])
        ret$val[nr] <- gsub(sprintf('%s%s',mc$new_val[i],strrep('&',mc$n[i])),
                                   mc$old_val[i],
                                   ret$val[nr],
                                   fixed = TRUE)
      }
    }
  }
  
  if(nrow(ret)==1){
    line_end <- ''
  }else{
    line_end <- '\\\\'
  }

  ret <- ret%>%
    mutate(line_end=line_end)
  
  if(!is.null(ah)){
    for(i in seq_along(ah)){
      ret$line_end[ah[i]] <- gsub(line_end,
                               '\\\\ \\hline',
                               ret$line_end[ah[i]],
                               fixed = TRUE)   
    }
  }
  
  if(!is.null(ac)){
    
    for(i in seq_along(ac)){
      ret$line_end[ac[[i]]['line']] <- gsub(line_end,sprintf('\\\\ \\cline{%s-%s}',
                                                        ac[[i]]['i'],ac[[i]]['j']),
                                       ret$line_end[ac[[i]]['line']],
                                       fixed = TRUE)
    }

  }
  
   #ret$line_end[nrow(ret)] <- gsub('^\\\\\\\\','',ret$line_end[nrow(ret)])
  
   ret <- ret%>%
     dplyr::mutate(val = sprintf('%s%s',!!rlang::sym('val'),line_end))%>%
      dplyr::summarise(val=paste0(!!rlang::sym('val'),
                                collapse = '\n'))%>%
      dplyr::pull(!!rlang::sym('val'))
  
   if(!is.null(ah)){
     if(0%in%ah){
       ret <- sprintf('\\hline\n%s',ret)
     }
   }
   
   if(!is.null(ac)){

     ac_idx <- sapply(ac,'[[',1)
     ac_idx0 <- which(ac_idx==0)
     
     if(length(ac_idx0)>0){
       ret <- sprintf('\\cline{%s-%s}\n%s',ac[[ac_idx0]]['i'],ac[[ac_idx0]]['j'],ret)
     }
   }
   
  as.tb(ret)
}

# as.data.frame.tb roxy [sinew] ---- 
#' @title convert texblock to data.frame
#' @description convert a texblock class into a data.frame
#' @param x texblock object
#' @param \dots pass convert as a boolean argument to apply type.convert to the output columns
#' @return data.frame
#' @examples 
#' x <- '1'
#' class(x) <- 'tb'
#' x1 <- x+x
#' as.data.frame(x1)
#' as.data.frame(x1,convert = TRUE)
#' 
#' @rdname as.data.frame.tb
#' @export 
#' @importFrom purrr map transpose set_names flatten_chr
#' @import dplyr
#' @importFrom utils type.convert
# as.data.frame.tb function [sinew] ----
as.data.frame.tb <- function(x,...){

  convert <- FALSE
  
  list2env(list(...),envir = environment())
  
  attr_env <- new.env()
  
  x <- strip(x,attr_env)
  
  l <- x%>%
    parse_tb()%>%
    purrr::map(function(x) {
      ret <- gsub('^_|_$','',strsplit(x,split = 'NEWCOL')[[1]]) 
      if(length(ret)==0)
        ret <- ''
      
      ret
    })%>%
    purrr::transpose()
  
  ret <- l%>%
    purrr::set_names(seq_along(l))%>%
    dplyr::as_tibble()%>%
    dplyr::mutate_all(purrr::flatten_chr)
  
  if(convert){
    ret <- ret %>%
     dplyr::mutate_all(utils::type.convert)%>%
     dplyr::mutate_if(is.factor,as.character)    
  }

  ret <- ret%>%
    restore(attr_env)
  
  return(ret)
}

# as.matrix.tb roxy [sinew] ---- 
#' @export
# as.matrix.tb function [sinew] ----
as.matrix.tb <- function(x,...){
  ret <- x%>%as.data.frame(convert=TRUE)%>%as.matrix()
  ret[which(is.na(ret),arr.ind = TRUE)] <- 0
  ret
}
